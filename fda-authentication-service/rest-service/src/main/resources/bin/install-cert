#!/bin/bash
KEY_STORE_LOCATION="./rest-service/src/main/resources/ssl/dbrepo.p12"
KEY_STORE_ALIAS="dbrepo"
KEY_STORE_PASS="dbrepo"

# REQUEST
certbot certonly --standalone --preferred-challenges http -d dbrepo.ossdip.at \
		-m martin.weise@tuwien.ac.at --agree-tos

# COMBINE
cat /etc/letsencrypt/live/dbrepo.ossdip.at/cert.pem /etc/letsencrypt/live/dbrepo.ossdip.at/privkey.pem > /tmp/comb.pem

# CONVERT TO PKCS12
keytool -import -alias root -keystore "${KEY_STORE_LOCATION}" -storepass "${KEY_STORE_PASS}" \
  -trustcacerts -file /etc/letsencrypt/live/dbrepo.ossdip.at/chain.pem
keytool -import -alias "${KEY_STORE_ALIAS}" -keystore "${KEY_STORE_LOCATION}" -storepass "${KEY_STORE_PASS}" \
  -trustcacerts -file /tmp/comb.pem

# CLEAN
rm -f /tmp/comb.pem