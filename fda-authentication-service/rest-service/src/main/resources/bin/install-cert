#!/bin/bash
KEY_STORE_LOCATION="./rest-service/src/main/resources/ssl/dbrepo.p12"
KEY_STORE_ALIAS="dbrepo"
KEY_STORE_PASS="dbrepo"

# REQUEST
certbot certonly --standalone --preferred-challenges http -d dbrepo.ossdip.at \
		-m martin.weise@tuwien.ac.at --agree-tos

# PEM to CRT
openssl x509 -outform der -in /etc/letsencrypt/live/dbrepo.ossdip.at/cert.pem \
 -out /etc/letsencrypt/live/dbrepo.ossdip.at/cert.crt
openssl x509 -outform der -in /etc/letsencrypt/live/dbrepo.ossdip.at/chain.pem \
 -out /etc/letsencrypt/live/dbrepo.ossdip.at/chain.crt

# PEM to KEY
openssl rsa -outform pem -inform pem -in /etc/letsencrypt/live/dbrepo.ossdip.at/privkey.pem \
  -out /etc/letsencrypt/live/dbrepo.ossdip.at/privkey.key

# MAKE KEYSTORE
openssl pkcs12 -export -in /etc/letsencrypt/live/dbrepo.ossdip.at/cert.crt \
 -inkey /etc/letsencrypt/live/dbrepo.ossdip.at/privkey.key -chain \
 -passout "pass:${KEY_STORE_PASS}" -CAfile /etc/letsencrypt/live/dbrepo.ossdip.at/chain.crt \
 -name "${KEY_STORE_ALIAS}" -out "${KEY_STORE_LOCATION}"
